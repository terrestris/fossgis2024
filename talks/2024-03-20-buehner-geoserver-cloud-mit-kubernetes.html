<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>GeoServer Cloud mit Kubernetes</title>

	<link rel="stylesheet" href="../reveal.js/dist/reset.css">
	<link rel="stylesheet" href="../reveal.js/dist/reveal.css">
	<link rel="stylesheet" href="../reveal.js/dist/theme/league.css">

	<!-- Theme used for syntax highlighted code -->
	<link rel="stylesheet" href="../reveal.js/plugin/highlight/monokai.css">
</head>

<body>
	<div class="reveal">
		<div class="slides">
			<section id="start" data-background="../img/gs-cloud-bg.svg" data-background-size="contain"></section>

			<section id="title" data-background="../img/gs-cloud-bg.svg" data-background-size="contain"
				data-background-opacity="0.3">
				<h1>GeoServer Cloud<br>mit Kubernetes</h1>
				<p style="margin-top: 1em;">
					Nils Bühner, terrestris
				</p>
				<p style="font-size: 0.7em;">
					FOSSGIS 2024 | 20. M&auml;rz 2024 | Hamburg
				</p>
			</section>

			<section id="toc">
				<h3>Fahrplan</h3>
				<ul>
					<li>Vorstellung und Einordnung des Vortrags</li>
					<li>Cloud-Probleme des "klassischen" GeoServer</li>
					<li>Deswegen: GeoServer Cloud</li>
					<li>Deployment am Beispiel Kubernetes (Video-Demo)</li>
				</ul>
			</section>

			<section id="me">
				<h3>Nils Bühner</h3>
				<div style="display: flex">

					<ul style="flex: 3">
						<li>Informatiker</li>
						<li>Entwickler bei <a href="https://www.terrestris.de/" target="_blank">terrestris</a></li>
						<li>Maintainer des <a href="https://github.com/geoserver/docker" target="_blank">GeoServer Docker Images</a></li>
						<li>Interessen und Schwerpunkte
							<ul>
								<li>Java, Python, JavaScript</li>
								<li>GeoServer</li>
								<li>PostgreSQL/PostGIS</li>
								<li>Docker</li>
								<li>CICD/Infrastruktur</li>
							</ul>
						</li>
					</ul>
					<div style="flex: 2; font-size: 0.5em;">
						<img src="../img/nb.png" />
						<a href="mailto:buehner@terrestris.de">buehner@terrestris.de</a><img
							style="height: 0.9em;margin:0" src="../img/mail-logo.png" alt="E-Mail"><br />
						<a href="https://github.com/buehner/" target="_blank">github.com/buehner</a><img style="height: 0.9em;margin:0"
							src="../img/github-logo.png" alt="GitHub"><br />
						<img style="width: 12em;" src="../img/terrestris.svg" alt="terrestris Logo"><br />
					</div>
				</div>
			</section>

			<section id="einordnung">
				<h3>Einordnung und Motivation</h3>
				<ul>
					<li>Interesse am Thema</li>
					<li>(Noch) kein Power-User</li>
					<li>(Noch) kein Kernentwickler</li>
					<li><a href="https://www.terrestris.de/de/2023/09/29/teambuilding-und-zusammenhalt-technologien-und-strukturen-rueckblick-auf-die-klausurtagung-2023-in-den-niederlanden/" target="_blank">Klausurtagung 2023</a> mit terrestris</li>
					<li>"Bericht" über meine Erfahrungen</li>
				</ul>
			</section>

			<section id="geoserver" data-background="../img/gs.svg" data-background-size="contain"
				data-background-opacity="0.2">
				<h3>GeoServer</h3>
				<div>
					<ul>
						<li>Open Source Server für Geodaten</li>
						<li>Erweiterbar durch Plugins/Extensions</li>
						<li>Monolithische Applikation</li>
						<li>OGC-Standards
							<ul>
								<li>WMS</li>
								<li>WFS</li>
								<li>WPS</li>
								<li>… mehr</li>
							</ul>
						</li>
						<li>GeoFencing</li>
					</ul>
				</div>
			</section>

			<section id="geoserver-classic-cloud" >
				<h3>Monolithischer GeoServer in der Cloud</h3>
				<div style="display: flex">
					<div>
						<div>
							<img src="../img/gs-classic-cloud.png">
						</div>
						<div style="font-size: 0.4em;">Quelle: "Scaling GeoServer in the cloud clustering state of the art"<br>FOSS4G 2023 (<a href="https://speakerdeck.com/simboss/scaling-geoserver-in-the-cloud-clustering-state-of-the-art-foss4g-2023" target="_blank">Slides</a>, <a href="https://www.youtube.com/watch?v=zlQRHnaz6fY" target="_blank">Video</a>)</div>
					</div>
					<div>
						<div style="font-size: 0.7em; margin-top: 1em;">Probleme</div>
						<div style="font-size: 0.6em; margin: 1em 0 0 1em;">
							<ul>
								<li>Proxy/Load Balancing</li>
								<li>Synchronisierung zwischen den Instanzen</li>
								<li>Monitoring, Logging & Caching</li>
								<li>Kompatibilität von Extensions?</li>
							</ul>
						</div>
					</div>
				</div>
			</section>

			<section id="geoserver-cloud" data-background="../img/gs.svg" data-background-size="contain"
			data-background-opacity="0.1">
				<h3>GeoServer Cloud</h3>
				<div>
					<ul>
						<li><a href="https://github.com/geoserver/geoserver-cloud" target="_blank">https://github.com/geoserver/geoserver-cloud</a></li>
						<ul style="font-size: 0.7em;">
							<li><a href="https://github.com/geoserver/geoserver-cloud-config" target="_blank">https://github.com/geoserver/geoserver-cloud-config</a></li>
							<li><a href="https://github.com/geoserver/geoserver-acl" target="_blank">https://github.com/geoserver/geoserver-acl</a></li>
						</ul>
						<li>Eigenes Projekt "on top"</li>
						<li>Cloud native & DevOps friendly</li>
						<li>Wiederverwendung bestehender GeoServer Logik</li>
						<li>Entkopplung hin zu individuell skalierbaren Microservices</li>
						<li>Spring (Boot)!</li>
					</ul>
				</div>
			</section>

			<section id="geoserver-cloud-architecture" >
				<h3>GeoServer Cloud Architektur</h3>
				<div style="display: flex">
					<div>
						<div>
							<img src="../img/gs-cloud-architecture.svg" style="width: 75%;">
						</div>
						<div style="font-size: 0.4em;">Quelle: <a href="https://github.com/geoserver/geoserver-cloud/blob/main/docs/img/gs_cloud_architecture_diagram.svg" target="_blank">Github</a></div>
					</div>
					<div>
						<div style="font-size: 0.8em;">Microservices</div>
						<div style="font-size: 0.6em; margin: 1em 0 1em 0;">
							<ul>
								<li>Web UI</li>
								<li>WMS</li>
								<li>WFS</li>
								<li>WPS</li>
								<li>WCS</li>
								<li>GWC</li>
								<li>REST</li>
							</ul>
						</div>
						<div style="font-size: 0.8em;">Außerdem:</div>
						<div style="font-size: 0.6em; margin: 1em 0 0 0;">
							<ul>
								<li>Front Gateway als "single entry point" und Load Balancer</li>
								<li>Event Bus (RabbitMQ bzw. Spring Cloud Bus)</li>
								<li>Catalog (XML oder JDBC)</li>
							</ul>
						</div>
					</div>
				</div>
			</section>

			<section id="maven-pom">
				<h3>Maven pom.xml</h3>
				<pre>
<code data-line-numbers="25-28|12"><project>
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.geoserver.cloud.apps</groupId>
		<artifactId>gs-cloud-services</artifactId>
		<version>${revision}</version>
	</parent>
	<artifactId>gs-cloud-wms</artifactId>
	<packaging>jar</packaging>
	<name>wms-service</name>
	<properties>
		<start-class>org.geoserver.cloud.wms.app.WmsApplication</start-class>
	</properties>
	<dependencies>
		<dependency>
			<groupId>org.geoserver.cloud</groupId>
			<artifactId>gs-cloud-starter-webmvc</artifactId>
			<exclusions>
				<exclusion>
				<groupId>org.geoserver</groupId>
				<artifactId>gs-gwc</artifactId>
				</exclusion>
			</exclusions>
		</dependency>
		<dependency>
			<groupId>org.geoserver</groupId>
			<artifactId>gs-wms</artifactId>
		</dependency>
		<dependency>
			<groupId>org.geoserver.cloud</groupId>
			<artifactId>gs-cloud-starter-wms-extensions</artifactId>
		</dependency>
		<dependency>
			<groupId>org.geoserver.cloud</groupId>
			<artifactId>gs-cloud-starter-security</artifactId>
		</dependency>
		...
	</dependencies>
	...
</project>
				</code></pre>
				<div style="font-size: 0.4em;">Quelle: <a href="https://github.com/geoserver/geoserver-cloud/blob/main/src/apps/geoserver/wms/pom.xml" target="_blank">WMS pom.xml auf github</a></div>
			</section>

			<section id="java-code-spring">
				<h3>Java Code (Spring Boot)</h3>
				<pre>
<code data-line-numbers="7">@SpringBootApplication
@EnableRetry
public class WmsApplication {

	public static void main(String[] args) {
		try {
			SpringApplication.run(WmsApplication.class, args);
		} catch (RuntimeException e) {
			try {
				LoggerFactory.getLogger(WmsApplication.class).error("Application run failed", e);
			} finally {
				System.exit(-1);
			}
		}
	}
}
				</code></pre>
				<div style="font-size: 0.4em;">Quelle: <a href="https://github.com/geoserver/geoserver-cloud/blob/main/src/apps/geoserver/wms/src/main/java/org/geoserver/cloud/wms/app/WmsApplication.java" target="_blank">WmsApplication.java auf github</a></div>
			</section>

			<section id="java-code-controller">
				<h3>Java Code (Spring Web Controller)</h3>
				<pre>
<code data-line-numbers="17-19|32-36|38-41|21|7">package org.geoserver.cloud.wms.controller;

import lombok.NonNull;
import lombok.RequiredArgsConstructor;

import org.geoserver.cloud.virtualservice.VirtualServiceVerifier;
import org.geoserver.ows.Dispatcher;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.servlet.view.RedirectView;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Controller
@RequiredArgsConstructor
public class WMSController {

	private final @NonNull Dispatcher geoserverDispatcher;

	private final @NonNull org.geoserver.ows.ClasspathPublisher classPathPublisher;

	private final @NonNull VirtualServiceVerifier virtualServiceVerifier;

	@GetMapping("/")
	public RedirectView redirectRootToGetCapabilities() {
		return new RedirectView("/wms?SERVICE=WMS&REQUEST=GetCapabilities");
	}

	@GetMapping(path = {"/wms", "/ows"})
	public void handleGet(HttpServletRequest request, HttpServletResponse response)
			throws Exception {
		dispatch(request, response);
	}

	private void dispatch(HttpServletRequest request, HttpServletResponse response)
		throws Exception {
		geoserverDispatcher.handleRequest(request, response);
	}
}
				</code></pre>
				<div style="font-size: 0.4em;">Quelle: <a href="https://github.com/geoserver/geoserver-cloud/blob/main/src/apps/geoserver/wms/src/main/java/org/geoserver/cloud/wms/controller/WMSController.java" target="_blank">WMSController.java auf github</a></div>
			</section>

			<section id="wms-dockerfile">
				<h3>WMS Microservice Dockerfile</h3>
				<pre>
<code data-line-numbers="1-8|11-18">ARG TAG=latest
FROM geoservercloud/gs-cloud-base-jre:$TAG as builder

ARG JAR_FILE=target/gs-cloud-*-bin.jar

COPY ${JAR_FILE} application.jar

RUN java -Djarmode=layertools -jar application.jar extract

##########
FROM geoservercloud/gs-cloud-base-geoserver-image:$TAG

COPY --from=builder dependencies/ ./
COPY --from=builder snapshot-dependencies/ ./
COPY --from=builder spring-boot-loader/ ./
COPY --from=builder application/ ./
				</code></pre>
				<div style="font-size: 0.4em;">Quelle: <a href="https://github.com/geoserver/geoserver-cloud/blob/main/src/apps/geoserver/wms/Dockerfile" target="_blank">WMS Dockerfile auf github</a></div>
			</section>

			<section id="fazit">
				<h3>Fazit</h3>
				<div style="font-size: 0.8em;">
					<ul>
						<li>Vorteile</li>
						<ul>
							<li>Native Einbindung in moderne Cloud-Umgebungen</li>
							<ul>
								<li>Skalierbarkeit/Dimensionierung</li>
								<li>Verfügbarkeit ("Service isolation")</li>
								<li>Gute Monitoring und Telemetrie-Unterstützung</li>
								<li>Location transparency</li>
							</ul>
							<li>Mehr Sicherheit durch potenziell kleineren Angriffsvektor</li>
						</ul>
						<li>Nachteile</li>
						<ul>
							<li>Kompatibilität von Erweiterungen</li>
							<li>Komplexeres Setup in Cloud-Umgebung</li>
							<li>bislang überschaubare Dokumentation</li>
						</ul>
					</ul>
				</div>
			</section>

			<section id="ausblick">
				<h3>Ausblick</h3>
				<div style="font-size: 0.8em;">
					<ul>
						<li>Quelle: Kernentwickler <a href="https://github.com/groldan" target="_blank">Gabriel Roldan</a></li>
						<li>GS Cloud Release v1.7.0 (GS 2.25.0)</li>
						<li>Neues config plugin "pgconfig" als hocheffizienter PostgreSQL-Katalog (ersetzt jdbconfig bzw. file-based XML catalog)</li>
						<li>GeoServer ACL (Access Control List) statt GeoFence</li>
						<ul>
							<li>GS Cloud kompatibel</li>
							<li>skalierbarer Microservice</li>
							<li>eigene REST-API</li>
							<li>OpenAPI -> Code-Generierung für Clients</li>
						</ul>
					</ul>
				</div>
			</section>

			<section id="kind">
				<h3>Kubernetes in Docker (KIND)</h3>
					<ul>
						<li>Kubernetes: Open-Source-System zur Verwaltung einer Container-Infrastruktur</li>
						<li><a href="https://github.com/terrestris/kind-dev-cluster" target="_blank">https://github.com/terrestris/kind-dev-cluster</a></li>
						<li>Lokaler Kubernetes Cluster</li>
						<li>"Spielwiese"</li>
						<li>Vorinstalliert:</li>
						<ul>
							<li>ingress-nginx</li>
							<li>Kubernetes Dashboard</li>
						</ul>
						<li>Installation von GeoServer cloud via <a href="https://github.com/terrestris/helm-charts/tree/main/charts/geoserver-cloud" target="_blank">helm chart</a></li>
					</ul>
			</section>

			<section id="video-demo">
				<h3>Zum Schluss: Video-Demo</h3>
				<ul>
					<li>Lokalen Kubernetes Cluster starten</li>
					<li>Login ins Dashboard</li>
					<li>Installation von GeoServer Cloud</li>
					<li>Anpassung auf "Nur WMS"</li>
				</ul>
			</section>

			<section id="start-kind">
				<h3>Lokalen Kubernetes cluster starten</h3>
				<video controls data-src="../video/gs-cloud/01-start-kind.mp4"></video>
			</section>

			<section id="dashboard-login">
				<h3>Dashboard login</h3>
				<video controls data-src="../video/gs-cloud/02-login-dashboard.mp4"></video>
			</section>

			<section id="install-gs-cloud">
				<h3>GeoServer cloud mit helm installieren</h3>
				<video controls data-src="../video/gs-cloud/03-install-gs-cloud.mp4"></video>
			</section>

			<section id="use-gs-cloud">
				<h3>GeoServer Cloud GUI nutzen</h3>
				<video controls data-src="../video/gs-cloud/04-use-gs.mp4"></video>
			</section>

			<section id="use-wms-only">
				<h3>WMS only</h3>
				<video controls data-src="../video/gs-cloud/05-use-only-wms.mp4"></video>
			</section>

			<section id="fragen">
				<h3>Fragen?</h3>
				<img src="../img/slides-qr.png" style="width: 50%;" />
			</section>
		</div>
	</div>

	<script src="../reveal.js/dist/reveal.js"></script>
	<script src="../reveal.js/plugin/notes/notes.js"></script>
	<script src="../reveal.js/plugin/markdown/markdown.js"></script>
	<script src="../reveal.js/plugin/highlight/highlight.js"></script>
	<script>
		// More info about initialization & config:
		// - https://revealjs.com/initialization/
		// - https://revealjs.com/config/
		Reveal.initialize({
			hash: true,
			autoPlayMedia: false,

			// Learn about plugins: https://revealjs.com/plugins/
			plugins: [RevealMarkdown, RevealHighlight, RevealNotes]
		});
	</script>
</body>

</html>
